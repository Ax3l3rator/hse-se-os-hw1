#include <fcntl.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <sys/ipc.h>
#include <sys/msg.h>
#include <sys/stat.h>
#include <sys/types.h>
#include <unistd.h>

#include "../method.h"

#define msg_buf 200

typedef struct msgbuf {
    long mtype;
    char mtext[msg_buf];
} message_buf;

void sys_error(char* msg) {
    puts(msg);
    exit(-1);
}

int main(int argc, char* argv[]) {
    int n;

    printf("Enter the lenth of string: ");
    scanf("%d", &n);

    if (set_len(n) > 0) {
        sys_error("Wrong length. Should be between 0 and 128");
    }

    int firsd_qid, second_qid;

    key_t first_key = 10, second_key = 20;

    message_buf* buf = (message_buf*)malloc(sizeof(message_buf));
    buf->mtype = 1;
    if ((firsd_qid = msgget(first_key, 0666)) < 0) {
        sys_error("Can\'t open msg queue");
    }

    if ((second_qid = msgget(second_key, 0666)) < 0) {
        sys_error("Can\'t open msg queue");
    }

    ssize_t read_size;
    char answer[msg_buf];
    while ((read_size = msgrcv(firsd_qid, buf, msg_buf, 1, 0)) > 0) {
        int len = calculate(buf->mtext, read_size, answer);
        if (len == 0) {
            strncpy(answer, "[no_answer]", 12);
            len = 12;
        }
        strncpy(buf->mtext, answer, len);
        if (msgsnd(second_qid, buf, len, 0) < 0) {
            sys_error("Can\'t write message");
        }
    }

    if (get_len() != n) {
        strncpy(buf->mtext, "[no_answer]", 12);

        if (msgsnd(second_qid, buf, 12, 0) < 0) {
            sys_error("Can\'t write message");
        }

    } else {
        strncpy(buf->mtext, "OK", 2);
        if (msgsnd(second_qid, buf, 2, 0)) {
            sys_error("Can\'t write message");
        }
    }

    return 0;
}
/*
?───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
?─██████████████─████████──████████─██████████████─██████─────────██████████████─████████████████───██████████████─██████████████─██████████████─████████████████───
?─██░░░░░░░░░░██─██░░░░██──██░░░░██─██░░░░░░░░░░██─██░░██─────────██░░░░░░░░░░██─██░░░░░░░░░░░░██───██░░░░░░░░░░██─██░░░░░░░░░░██─██░░░░░░░░░░██─██░░░░░░░░░░░░██───
?─██░░██████░░██─████░░██──██░░████─██████████░░██─██░░██─────────██████████░░██─██░░████████░░██───██░░██████░░██─██████░░██████─██░░██████░░██─██░░████████░░██───
?─██░░██──██░░██───██░░░░██░░░░██───────────██░░██─██░░██─────────────────██░░██─██░░██────██░░██───██░░██──██░░██─────██░░██─────██░░██──██░░██─██░░██────██░░██───
?─██░░██████░░██───████░░░░░░████───██████████░░██─██░░██─────────██████████░░██─██░░████████░░██───██░░██████░░██─────██░░██─────██░░██──██░░██─██░░████████░░██───
?─██░░░░░░░░░░██─────██░░░░░░██─────██░░░░░░░░░░██─██░░██─────────██░░░░░░░░░░██─██░░░░░░░░░░░░██───██░░░░░░░░░░██─────██░░██─────██░░██──██░░██─██░░░░░░░░░░░░██───
?─██░░██████░░██───████░░░░░░████───██████████░░██─██░░██─────────██████████░░██─██░░██████░░████───██░░██████░░██─────██░░██─────██░░██──██░░██─██░░██████░░████───
?─██░░██──██░░██───██░░░░██░░░░██───────────██░░██─██░░██─────────────────██░░██─██░░██──██░░██─────██░░██──██░░██─────██░░██─────██░░██──██░░██─██░░██──██░░██─────
?─██░░██──██░░██─████░░██──██░░████─██████████░░██─██░░██████████─██████████░░██─██░░██──██░░██████─██░░██──██░░██─────██░░██─────██░░██████░░██─██░░██──██░░██████─
?─██░░██──██░░██─██░░░░██──██░░░░██─██░░░░░░░░░░██─██░░░░░░░░░░██─██░░░░░░░░░░██─██░░██──██░░░░░░██─██░░██──██░░██─────██░░██─────██░░░░░░░░░░██─██░░██──██░░░░░░██─
?─██████──██████─████████──████████─██████████████─██████████████─██████████████─██████──██████████─██████──██████─────██████─────██████████████─██████──██████████─
?───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
*/