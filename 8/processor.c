#include <fcntl.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <sys/stat.h>
#include <sys/types.h>
#include <unistd.h>

#include "../method.h"

const int buffer_size = 8192;

void sys_error(char* msg) {
    puts(msg);
    exit(-1);
}

int main(int argc, char* argv[]) {
    int fifo_read_descriptor, fifo_write_descriptor;
    ssize_t fifo_write_size, fifo_read_size;
    char buffer[buffer_size];

    char* fifo_read_name = "./1.fifo";
    char* fifo_write_name = "./2.fifo";

    int n;

    printf("Enter the lenth of string: ");
    scanf("%d", &n);

    if (set_len(n) > 0) {
        sys_error("Wrong length. Should be between 0 and 128");
    }

    if ((fifo_read_descriptor = open(fifo_read_name, O_RDONLY)) < 0) {
        sys_error("Can\'t open FIFO for reading/writitng\n");
    }

    if ((fifo_write_descriptor = open(fifo_write_name, O_WRONLY)) < 0) {
        sys_error("Can\'t open FIFO for reading/writitng\n");
    }

    char answer[buffer_size];
    if ((fifo_read_size = read(fifo_read_descriptor, buffer, buffer_size)) < 0) {
        sys_error("Can\'t read from FIFO");
    }
    int answer_length = calculate(buffer, fifo_read_size, answer);

    if (answer_length == 0 || answer_length != n) {
        strncpy(answer, "[no_answer]", 12);
        answer_length = 12;
    }
    // printf("%d", answer_length);

    fifo_write_size = write(fifo_write_descriptor, answer, answer_length);

    if (fifo_write_size != answer_length) {
        sys_error("Can\'t write whole string to FIFO\n");
    }

    if (fifo_write_size < 0) {
        sys_error("Can\'t read string from FIFO\n");
    }

    if (close(fifo_write_descriptor) < 0) {
        sys_error("Can\'t close FIFO\n");
    }

    if (close(fifo_read_descriptor) < 0) {
        sys_error("Can\'t close FIFO\n");
    }

    return 0;
}
/*
?───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
?─██████████████─████████──████████─██████████████─██████─────────██████████████─████████████████───██████████████─██████████████─██████████████─████████████████───
?─██░░░░░░░░░░██─██░░░░██──██░░░░██─██░░░░░░░░░░██─██░░██─────────██░░░░░░░░░░██─██░░░░░░░░░░░░██───██░░░░░░░░░░██─██░░░░░░░░░░██─██░░░░░░░░░░██─██░░░░░░░░░░░░██───
?─██░░██████░░██─████░░██──██░░████─██████████░░██─██░░██─────────██████████░░██─██░░████████░░██───██░░██████░░██─██████░░██████─██░░██████░░██─██░░████████░░██───
?─██░░██──██░░██───██░░░░██░░░░██───────────██░░██─██░░██─────────────────██░░██─██░░██────██░░██───██░░██──██░░██─────██░░██─────██░░██──██░░██─██░░██────██░░██───
?─██░░██████░░██───████░░░░░░████───██████████░░██─██░░██─────────██████████░░██─██░░████████░░██───██░░██████░░██─────██░░██─────██░░██──██░░██─██░░████████░░██───
?─██░░░░░░░░░░██─────██░░░░░░██─────██░░░░░░░░░░██─██░░██─────────██░░░░░░░░░░██─██░░░░░░░░░░░░██───██░░░░░░░░░░██─────██░░██─────██░░██──██░░██─██░░░░░░░░░░░░██───
?─██░░██████░░██───████░░░░░░████───██████████░░██─██░░██─────────██████████░░██─██░░██████░░████───██░░██████░░██─────██░░██─────██░░██──██░░██─██░░██████░░████───
?─██░░██──██░░██───██░░░░██░░░░██───────────██░░██─██░░██─────────────────██░░██─██░░██──██░░██─────██░░██──██░░██─────██░░██─────██░░██──██░░██─██░░██──██░░██─────
?─██░░██──██░░██─████░░██──██░░████─██████████░░██─██░░██████████─██████████░░██─██░░██──██░░██████─██░░██──██░░██─────██░░██─────██░░██████░░██─██░░██──██░░██████─
?─██░░██──██░░██─██░░░░██──██░░░░██─██░░░░░░░░░░██─██░░░░░░░░░░██─██░░░░░░░░░░██─██░░██──██░░░░░░██─██░░██──██░░██─────██░░██─────██░░░░░░░░░░██─██░░██──██░░░░░░██─
?─██████──██████─████████──████████─██████████████─██████████████─██████████████─██████──██████████─██████──██████─────██████─────██████████████─██████──██████████─
?───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
*/