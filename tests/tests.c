#include <fcntl.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <sys/ipc.h>
#include <sys/msg.h>
#include <sys/stat.h>
#include <sys/types.h>
#include <time.h>
#include <unistd.h>

#include "../method.h"

int main(int argc, char* argv[]) {
    if (argc < 2) {
        printf("Usage: %s [file_length] (optional)[-r](for true random)", argv[0]);
        exit(-1);
    }
    int len = atoi(argv[1]);
    if (argc >= 3 && strncmp(argv[2], "-r", 2) == 0) {
        srand(time(NULL));
    } else {
        srand(len);
    }

    char name[50];

    strcpy(name, "txt/");

    strcat(name, argv[1]);

    strcat(name, ".txt");
    int fd = open(name, O_WRONLY | O_CREAT, 0666);

    int sample_fd = open("src/pattern.txt", O_RDONLY);

    int ans_len = rand() % (len - 1 < 128 ? len - 1 : 128) + 1;

    int offset = rand() % (128 - ans_len);

    int insert_pos = rand() % (len - ans_len + 1);

    // printf("%d %d %d\n", ans_len, offset, insert_pos);
    char writen[1];

    for (int i = 0; i < len; ++i) {
        writen[0] = rand() % 128;

        if (i == insert_pos) {
            for (int j = 0; j < ans_len; ++j) {
                writen[0] = 127 - offset - j;
                write(fd, writen, 1);
                // printf("%d %d\n", writen[0], i + j);
            }
            continue;
        }
        write(fd, writen, 1);
        // printf("%d %d\n", writen[0], i);
    }

    close(sample_fd);
    close(fd);
    fd = open(name, O_RDONLY);
    char* str = (char*)malloc(len * sizeof(char));
    read(fd, str, len);
    close(fd);
    // printf("%d %s\n", len, str);

    memset(name, 0, 50);

    strcpy(name, "ans/");

    strcat(name, argv[1]);

    strcat(name, ".txt");

    fd = open(name, O_WRONLY | O_CREAT);

    char* buf_ans = (char*)malloc(len * sizeof(char));

    char answer[128];
    set_len(ans_len);
    int fin_len = calculate(str, len, answer);
    char digit[5];
    sprintf(buf_ans, "%d\n%s", fin_len, answer);

    sprintf(digit, "%d", fin_len);

    write(fd, buf_ans, strlen(digit) + 1 + fin_len);

    // printf("Answer length is %d\n", ans_len);

    // printf("Pre-test length:\n%d\nPre-test answer:\n%s\n", fin_len, answer);
    free(str);
    return 0;
}
/*
?───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
?─██████████████─████████──████████─██████████████─██████─────────██████████████─████████████████───██████████████─██████████████─██████████████─████████████████───
?─██░░░░░░░░░░██─██░░░░██──██░░░░██─██░░░░░░░░░░██─██░░██─────────██░░░░░░░░░░██─██░░░░░░░░░░░░██───██░░░░░░░░░░██─██░░░░░░░░░░██─██░░░░░░░░░░██─██░░░░░░░░░░░░██───
?─██░░██████░░██─████░░██──██░░████─██████████░░██─██░░██─────────██████████░░██─██░░████████░░██───██░░██████░░██─██████░░██████─██░░██████░░██─██░░████████░░██───
?─██░░██──██░░██───██░░░░██░░░░██───────────██░░██─██░░██─────────────────██░░██─██░░██────██░░██───██░░██──██░░██─────██░░██─────██░░██──██░░██─██░░██────██░░██───
?─██░░██████░░██───████░░░░░░████───██████████░░██─██░░██─────────██████████░░██─██░░████████░░██───██░░██████░░██─────██░░██─────██░░██──██░░██─██░░████████░░██───
?─██░░░░░░░░░░██─────██░░░░░░██─────██░░░░░░░░░░██─██░░██─────────██░░░░░░░░░░██─██░░░░░░░░░░░░██───██░░░░░░░░░░██─────██░░██─────██░░██──██░░██─██░░░░░░░░░░░░██───
?─██░░██████░░██───████░░░░░░████───██████████░░██─██░░██─────────██████████░░██─██░░██████░░████───██░░██████░░██─────██░░██─────██░░██──██░░██─██░░██████░░████───
?─██░░██──██░░██───██░░░░██░░░░██───────────██░░██─██░░██─────────────────██░░██─██░░██──██░░██─────██░░██──██░░██─────██░░██─────██░░██──██░░██─██░░██──██░░██─────
?─██░░██──██░░██─████░░██──██░░████─██████████░░██─██░░██████████─██████████░░██─██░░██──██░░██████─██░░██──██░░██─────██░░██─────██░░██████░░██─██░░██──██░░██████─
?─██░░██──██░░██─██░░░░██──██░░░░██─██░░░░░░░░░░██─██░░░░░░░░░░██─██░░░░░░░░░░██─██░░██──██░░░░░░██─██░░██──██░░██─────██░░██─────██░░░░░░░░░░██─██░░██──██░░░░░░██─
?─██████──██████─████████──████████─██████████████─██████████████─██████████████─██████──██████████─██████──██████─────██████─────██████████████─██████──██████████─
?───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
*/